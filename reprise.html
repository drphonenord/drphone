<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Reprise — Mode Pro</title>
<style>
  :root{--fg:#0b1220;--muted:#6b7280;--border:#e5e7eb;--brand:#2563eb;--bg:#f8fafc}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--fg);background:var(--bg)}
  .container{max-width:1000px;margin:0 auto;padding:20px 16px}
  .card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;margin-top:16px}
  label{display:block;margin:8px 0 4px}
  select,input{width:100%;padding:8px;border:1px solid var(--border);border-radius:10px}
  .grid{display:grid;gap:12px}
  .g2{grid-template-columns:1fr 1fr}
  .g3{grid-template-columns:1fr 1fr 1fr}
  .muted{color:var(--muted)}
  .result{font-size:1.25rem;font-weight:800}
  .pill{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:999px;margin-right:6px}
</style>
</head>
<body>
<div class="container">
  <h1>Estimation Reprise — Mode Pro</h1>
  <p class="muted">Règle : <b>plafond = médiane ajustée</b>, <b>ouverture = plafond −10%</b>. Les décotes s’appliquent avant.</p>

  <!-- Sélection appareil -->
  <div class="card">
    <h3>Appareil</h3>
    <div class="grid g3">
      <div>
        <label>Marque</label>
        <select id="brand"></select>
      </div>
      <div>
        <label>Modèle</label>
        <select id="model"></select>
      </div>
      <div>
        <label>Stockage (Go)</label>
        <select id="storage"></select>
      </div>
    </div>
    <p class="muted" id="baseInfo">Médiane de base : —</p>
  </div>

  <!-- État & défauts -->
  <div class="card">
    <h3>État</h3>
    <div class="grid g3">
      <div>
        <label>Écran</label>
        <select id="screen">
          <option value="ok">OK</option>
          <option value="micro">Micro-rayures</option>
          <option value="fissure">Fissure</option>
          <option value="broken">Cassé</option>
        </select>
      </div>
      <div>
        <label>Châssis</label>
        <select id="frame">
          <option value="ok">OK</option>
          <option value="wear">Usé / coin marqué</option>
          <option value="bent">Tordu</option>
        </select>
      </div>
      <div>
        <label>Liquide</label>
        <select id="liquid">
          <option value="none">Aucun</option>
          <option value="light">Suspicion légère</option>
          <option value="heavy">Contact avéré</option>
        </select>
      </div>
    </div>

    <div style="margin-top:12px">
      <label>Défauts additionnels (coche ce qui s’applique)</label>
      <div>
        <label class="pill"><input type="checkbox" class="defect" value="spk"> Haut-parleur</label>
        <label class="pill"><input type="checkbox" class="defect" value="mic"> Micro</label>
        <label class="pill"><input type="checkbox" class="defect" value="cam"> Caméra</label>
        <label class="pill"><input type="checkbox" class="defect" value="btn"> Boutons</label>
        <label class="pill"><input type="checkbox" class="defect" value="bat"> Batterie HS</label>
      </div>
    </div>

    <div style="margin-top:12px">
      <label class="pill"><input type="checkbox" id="locked"> Compte verrouillé / FMI on (non reprenable)</label>
    </div>
  </div>

  <!-- Résultat -->
  <div class="card">
    <h3>Résultat</h3>
    <div id="res" class="result">—</div>
    <p class="muted" id="detail">Décotes appliquées : —</p>
  </div>
</div>

<script>
// === Paramètres décotes (ajuste si besoin) ===
const DEDUCT = {
  screen: { ok: 0, micro: 0.05, fissure: 0.15, broken: 0.40 },
  frame:  { ok: 0, wear: 0.05, bent: 0.20 },
  liquid: { none: 0, light: 0.10, heavy: 0.30 },
  defectsEach: 0.05
};
// =============================================

const FN = "/.netlify/functions/prices";
const $ = s => document.querySelector(s);

let PRICES = {}; // structure { Brand: { Model: { Storage: {min,max} } } }

const median = (min,max) => (Number(min)+Number(max))/2;
const eur = x => Math.max(0, Math.round(x));

async function loadPrices(){
  const r = await fetch(FN);
  PRICES = await r.json() || {};
  fillSelectors();
  compute();
}

function fillSelectors(){
  const b = $('#brand'), m = $('#model'), s = $('#storage');
  // brand
  b.innerHTML = Object.keys(PRICES).sort().map(x=>`<option>${x}</option>`).join('') || '<option>—</option>';
  // model
  const brand = b.value || Object.keys(PRICES)[0];
  const models = brand ? Object.keys(PRICES[brand] || {}).sort() : [];
  m.innerHTML = models.map(x=>`<option>${x}</option>`).join('') || '<option>—</option>';
  // storage
  const model = m.value || models[0];
  const storages = (PRICES[brand] && PRICES[brand][model]) ? Object.keys(PRICES[brand][model]).sort((a,b)=>+a-+b) : [];
  s.innerHTML = storages.map(x=>`<option>${x}</option>`).join('') || '<option>—</option>';
  updateBaseInfo();
}

function getBase(){
  const brand = $('#brand').value;
  const model = $('#model').value;
  const storage = $('#storage').value;
  try { return { brand, model, storage, ...PRICES[brand][model][storage] }; }
  catch { return null; }
}

function updateBaseInfo(){
  const base = getBase();
  if(!base){ $('#baseInfo').textContent = 'Médiane de base : —'; return; }
  const med = eur(median(base.min, base.max));
  $('#baseInfo').textContent = `Médiane de base : ${med} € (min ${base.min} / max ${base.max})`;
}

function compute(){
  const base = getBase();
  if(!base){ $('#res').textContent = 'Aucun tarif interne pour cette config.'; $('#detail').textContent='—'; return; }

  const cond = {
    screen: $('#screen').value,
    frame:  $('#frame').value,
    liquid: $('#liquid').value,
    defects: [...document.querySelectorAll('.defect:checked')].map(x=>x.value),
    locked:  $('#locked').checked
  };

  if (cond.locked){
    $('#res').textContent = 'Non reprenable (compte/verrouillage actif).';
    $('#detail').textContent = 'Décotes appliquées : verrouillage';
    return;
  }

  const m = median(base.min, base.max);
  const d1 = DEDUCT.screen[cond.screen] || 0;
  const d2 = DEDUCT.frame[cond.frame]   || 0;
  const d3 = DEDUCT.liquid[cond.liquid] || 0;
  const dN = (cond.defects || []).length * DEDUCT.defectsEach;

  const total = d1 + d2 + d3 + dN;
  const medAdj = m * (1 - total);

  const ceiling  = eur(medAdj);           // médiane ajustée
  const opening  = eur(medAdj * 0.90);    // -10% ouverture

  $('#res').textContent = `Ouverture : ${opening} €   |   Plafond : ${ceiling} €`;
  $('#detail').textContent = `Décotes appliquées : écran=${(d1*100)|0}% ; châssis=${(d2*100)|0}% ; liquide=${(d3*100)|0}% ; défauts x${cond.defects.length} = ${(dN*100)|0}%  → total ${(total*100).toFixed(0)}%`;
}

['#brand','#model','#storage','#screen','#frame','#liquid','#locked'].forEach(sel=>{
  document.addEventListener('change', e=>{ if(e.target.matches(sel)) { if(sel!=='#brand'&&sel!=='#model') compute(); }});
});
document.addEventListener('change', e=>{
  if(e.target.matches('#brand')) { fillSelectors(); compute(); }
  if(e.target.matches('#model')) { fillSelectors(); compute(); }
});
document.addEventListener('click', e=>{
  if(e.target.classList && e.target.classList.contains('defect')) compute();
});

loadPrices();
</script>
</body>
</html>
